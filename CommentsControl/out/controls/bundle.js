/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
var pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad;
/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/******/ 	var __webpack_modules__ = ({

/***/ "./index.ts":
/*!******************!*\
  !*** ./index.ts ***!
  \******************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("{__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   CommentsControl: () => (/* binding */ CommentsControl)\n/* harmony export */ });\nvar __awaiter = undefined && undefined.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __generator = undefined && undefined.__generator || function (thisArg, body) {\n  var _ = {\n      label: 0,\n      sent: function sent() {\n        if (t[0] & 1) throw t[1];\n        return t[1];\n      },\n      trys: [],\n      ops: []\n    },\n    f,\n    y,\n    t,\n    g = Object.create((typeof Iterator === \"function\" ? Iterator : Object).prototype);\n  return g.next = verb(0), g[\"throw\"] = verb(1), g[\"return\"] = verb(2), typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n    while (g && (g = 0, op[0] && (_ = 0)), _) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n        case 7:\n          op = _.ops.pop();\n          _.trys.pop();\n          continue;\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n            _.ops.push(op);\n            break;\n          }\n          if (t[2]) _.ops.pop();\n          _.trys.pop();\n          continue;\n      }\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n/**\n * CommentsControl - tailored to your schema:\n *  - MessageProperty  -> ta_Text\n *  - DateProperty     -> ta_MessageDate\n *  - UserProperty     -> ta_User\n *  - ParentLookUpProp -> ta_SolutionCenterRequest   // change to ta_EmployerRequest if needed\n */\nvar MESSAGE_PROP = \"ta_Text\";\nvar DATE_PROP = \"ta_MessageDate\";\nvar USER_PROP = \"ta_User\";\nvar PARENT_PROP = \"ta_SolutionCenterRequest\"; // <-- switch to \"ta_EmployerRequest\" if that's your parent column\nvar CommentsControl = /** @class */function () {\n  function CommentsControl() {\n    this._isInitialized = false;\n  }\n  CommentsControl.prototype.init = function (context, _notifyOutputChanged, _state, container) {\n    var _this = this;\n    this._context = context;\n    this._container = container;\n    // Root\n    this._container.classList.add(\"comments-root\");\n    // List\n    var list = document.createElement(\"div\");\n    list.className = \"comments-list\";\n    list.setAttribute(\"role\", \"log\");\n    // Input\n    var inputWrap = document.createElement(\"div\");\n    inputWrap.className = \"comments-input-wrap\";\n    this._input = document.createElement(\"textarea\");\n    this._input.className = \"comments-input\";\n    this._input.rows = 1;\n    this._input.placeholder = \"Write a comment and press Enter…\";\n    this._input.addEventListener(\"keydown\", function (e) {\n      return _this.onKeyDown(e);\n    });\n    inputWrap.appendChild(this._input);\n    this._container.appendChild(list);\n    this._container.appendChild(inputWrap);\n    this._isInitialized = true;\n  };\n  CommentsControl.prototype.updateView = function (context) {\n    var _a, _b, _c, _d;\n    this._context = context;\n    if (!this._isInitialized) return;\n    var list = this._container.querySelector(\".comments-list\");\n    if (!list) return;\n    list.innerHTML = \"\";\n    var ds = context.parameters.dataset;\n    if (!ds || ds.loading) return;\n    // Render oldest -> newest; use your writable date if present, else Created On\n    var sorted = Object.keys(ds.records).map(function (k) {\n      return ds.records[k];\n    }).sort(function (a, b) {\n      var _a, _b;\n      var ad = (_a = a.getValue(DATE_PROP)) !== null && _a !== void 0 ? _a : a.getValue(\"createdon\");\n      var bd = (_b = b.getValue(DATE_PROP)) !== null && _b !== void 0 ? _b : b.getValue(\"createdon\");\n      var at = ad ? new Date(ad).getTime() : 0;\n      var bt = bd ? new Date(bd).getTime() : 0;\n      return at - bt;\n    });\n    for (var _i = 0, sorted_1 = sorted; _i < sorted_1.length; _i++) {\n      var rec = sorted_1[_i];\n      var row = document.createElement(\"div\");\n      row.className = \"comment-row\";\n      var body = document.createElement(\"div\");\n      body.className = \"comment-body\";\n      body.textContent = (_a = rec.getFormattedValue(MESSAGE_PROP)) !== null && _a !== void 0 ? _a : \"\";\n      var meta = document.createElement(\"div\");\n      meta.className = \"comment-meta\";\n      var userTxt = (_b = rec.getFormattedValue(USER_PROP)) !== null && _b !== void 0 ? _b : \"\";\n      var dateTxt = (_d = (_c = rec.getFormattedValue(DATE_PROP)) !== null && _c !== void 0 ? _c : rec.getFormattedValue(\"createdon\")) !== null && _d !== void 0 ? _d : \"\";\n      meta.textContent = [userTxt, dateTxt].filter(Boolean).join(\" · \");\n      row.appendChild(body);\n      row.appendChild(meta);\n      list.appendChild(row);\n    }\n  };\n  CommentsControl.prototype.getOutputs = function () {\n    return {};\n  };\n  CommentsControl.prototype.destroy = function () {\n    // no-op\n  };\n  // ===== Internals =====\n  CommentsControl.prototype.onKeyDown = function (e) {\n    return __awaiter(this, void 0, void 0, function () {\n      var text, err_1;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (!(e.key === \"Enter\" && !e.shiftKey)) return [3 /*break*/, 5];\n            // critical: prevent the form/subgrid from swallowing Enter\n            e.preventDefault();\n            e.stopPropagation();\n            text = (this._input.value || \"\").trim();\n            if (!text) return [2 /*return*/];\n            _a.label = 1;\n          case 1:\n            _a.trys.push([1, 4,, 5]);\n            return [4 /*yield*/, this.createComment(text)];\n          case 2:\n            _a.sent();\n            this._input.value = \"\";\n            return [4 /*yield*/, this._context.parameters.dataset.refresh()];\n          case 3:\n            _a.sent();\n            return [3 /*break*/, 5];\n          case 4:\n            err_1 = _a.sent();\n            // eslint-disable-next-line no-console\n            console.error(\"Failed to create comment\", err_1);\n            return [3 /*break*/, 5];\n          case 5:\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  CommentsControl.prototype.createComment = function (messageText) {\n    return __awaiter(this, void 0, void 0, function () {\n      var ctx, chatEntityLogicalName, userId, _a, parentEntityName, parentId, sysUserMeta, parentMeta, systemUsersSet, parentSet, payload;\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            ctx = this._context;\n            chatEntityLogicalName = ctx.parameters.dataset.getTargetEntityType && ctx.parameters.dataset.getTargetEntityType();\n            if (!chatEntityLogicalName) {\n              throw new Error(\"Cannot determine chat entity from dataset binding.\");\n            }\n            userId = (ctx.userSettings.userId || \"\").replace(/[{}]/g, \"\");\n            _a = this.getParentFromPageContext(ctx), parentEntityName = _a.parentEntityName, parentId = _a.parentId;\n            if (!parentEntityName || !parentId) {\n              throw new Error(\"Could not determine the parent record from page context.\");\n            }\n            return [4 /*yield*/, ctx.utils.getEntityMetadata(\"systemuser\")];\n          case 1:\n            sysUserMeta = _b.sent();\n            return [4 /*yield*/, ctx.utils.getEntityMetadata(parentEntityName)];\n          case 2:\n            parentMeta = _b.sent();\n            systemUsersSet = sysUserMeta.EntitySetName;\n            parentSet = parentMeta.EntitySetName;\n            payload = {};\n            payload[MESSAGE_PROP] = messageText;\n            payload[DATE_PROP] = new Date().toISOString();\n            payload[\"\".concat(USER_PROP, \"@odata.bind\")] = \"/\".concat(systemUsersSet, \"(\").concat(userId, \")\");\n            payload[\"\".concat(PARENT_PROP, \"@odata.bind\")] = \"/\".concat(parentSet, \"(\").concat(parentId, \")\");\n            // Create row\n            return [4 /*yield*/, ctx.webAPI.createRecord(chatEntityLogicalName, payload)];\n          case 3:\n            // Create row\n            _b.sent();\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  /**\n   * Tries multiple strategies to get the parent record info when the control is hosted on a subgrid within a form.\n   */\n  CommentsControl.prototype.getParentFromPageContext = function (ctx) {\n    var _a, _b, _c, _d, _e, _f, _g;\n    // 1) Preferred: context.mode.contextInfo (newer PCF runtimes)\n    var ci = (_a = ctx.mode) === null || _a === void 0 ? void 0 : _a.contextInfo;\n    if ((ci === null || ci === void 0 ? void 0 : ci.entityTypeName) && (ci === null || ci === void 0 ? void 0 : ci.entityId)) {\n      return {\n        parentEntityName: ci.entityTypeName,\n        parentId: ci.entityId.replace(/[{}]/g, \"\")\n      };\n    }\n    // 2) Fallback: legacy Xrm.Page (if available)\n    var XrmAny = window.Xrm;\n    if ((_c = (_b = XrmAny === null || XrmAny === void 0 ? void 0 : XrmAny.Page) === null || _b === void 0 ? void 0 : _b.data) === null || _c === void 0 ? void 0 : _c.entity) {\n      var id = ((_e = (_d = XrmAny.Page.data.entity).getId) === null || _e === void 0 ? void 0 : _e.call(_d)) || \"\";\n      var name_1 = ((_g = (_f = XrmAny.Page.data.entity).getEntityName) === null || _g === void 0 ? void 0 : _g.call(_f)) || \"\";\n      if (id && name_1) {\n        return {\n          parentEntityName: name_1,\n          parentId: id.replace(/[{}]/g, \"\")\n        };\n      }\n    }\n    // 3) Fallback: parse from URL (etn + id)\n    try {\n      var url = new URL(window.location.href);\n      var etn = url.searchParams.get(\"etn\");\n      var id = url.searchParams.get(\"id\");\n      if (etn && id) {\n        return {\n          parentEntityName: etn,\n          parentId: id.replace(/[{}]/g, \"\")\n        };\n      }\n    } catch (/* ignore */_h) {/* ignore */}\n    return {\n      parentEntityName: \"\",\n      parentId: \"\"\n    };\n  };\n  return CommentsControl;\n}();\n\n\n//# sourceURL=webpack://pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad/./index.ts?\n}");

/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The require scope
/******/ 	var __webpack_require__ = {};
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	(() => {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = (exports) => {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	})();
/******/ 	
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module can't be inlined because the eval devtool is used.
/******/ 	var __webpack_exports__ = {};
/******/ 	__webpack_modules__["./index.ts"](0, __webpack_exports__, __webpack_require__);
/******/ 	pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad = __webpack_exports__;
/******/ 	
/******/ })()
;
if (window.ComponentFramework && window.ComponentFramework.registerControl) {
	ComponentFramework.registerControl('Comments.CommentsControl', pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad.CommentsControl);
} else {
	var Comments = Comments || {};
	Comments.CommentsControl = pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad.CommentsControl;
	pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad = undefined;
}